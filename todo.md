# Business Process Builder - TODO

## Базовая настройка
- [x] Настроить схему базы данных
- [x] Создать миграции БД

## Backend API
- [x] Создать API для управления компаниями
- [x] Создать API для голосового интервью
- [x] Интегрировать Whisper API для транскрипции
- [x] Создать API для генерации бизнес-процессов через LLM
- [x] Создать API для работы с комментариями
- [x] Создать API для генерации рекомендаций
- [x] Добавить загрузку аудио файлов в S3

## Frontend - Основные страницы
- [x] Создать главную страницу (лендинг)
- [x] Создать страницу списка компаний
- [x] Создать страницу создания/редактирования компании
- [x] Создать страницу голосового интервью
- [x] Создать страницу просмотра бизнес-процесса
- [x] Создать страницу редактирования процесса
- [x] Создать страницу с рекомендациями

## Frontend - Компоненты
- [x] Компонент записи голоса
- [x] Компонент визуализации BPMN диаграммы
- [x] Компонент списка вопросов интервью
- [x] Компонент отображения этапов процесса
- [ ] Компонент комментариев к процессу
- [x] Компонент карточек рекомендаций

## Функциональность
- [x] Реализовать голосовое интервью с записью
- [x] Реализовать транскрипцию аудио
- [x] Реализовать генерацию бизнес-процесса из интервью
- [x] Реализовать визуализацию процесса (swimlane/BPMN)
- [ ] Реализовать редактирование процесса
- [ ] Реализовать систему комментариев
- [x] Реализовать генерацию рекомендаций по оптимизации
- [ ] Реализовать экспорт процесса в PDF

## Дизайн и UX
- [x] Настроить цветовую схему
- [x] Добавить анимации и переходы
- [x] Оптимизировать для мобильных устройств
- [x] Добавить loading состояния
- [x] Добавить error handling

## Тестирование
- [ ] Протестировать запись голоса
- [ ] Протестировать транскрипцию
- [ ] Протестировать генерацию процесса
- [ ] Протестировать визуализацию
- [ ] Протестировать редактирование
- [ ] Протестировать рекомендации

## Исправления
- [x] Исправить ошибку парсинга JSON при генерации бизнес-процесса
- [x] Добавить обработку ошибок и валидацию JSON ответов от LLM
- [x] Исправить дублирующиеся ключи в компоненте ProcessDiagram

## Новые функции
- [x] Добавить экспорт диаграммы в PNG/SVG
- [x] Реализовать zoom и pan controls для диаграммы
- [x] Добавить фильтры по ролям для диаграммы
- [x] Исправить генерацию рекомендаций
- [x] Исправить ошибку ReactFlowProvider в ProcessDiagram

## Переработка визуализации процесса
- [x] Реализовать swimlane layout (дорожки по ролям)
- [x] Добавить разные формы блоков (прямоугольник, ромб, овал, шестиугольник)
- [x] Реализовать drag-and-drop редактирование
- [x] Добавить функцию удаления блоков
- [x] Исправить переполнение текста в блоках
- [x] Добавить детальное описание МОП (материалы, оборудование, персонал)
- [x] Улучшить читаемость текста на цветных фонах

## Улучшения диаграммы
- [x] Добавить легенду типов блоков
- [x] Исправить отображение связей между блоками
- [x] Исправить отображение рекомендаций

## Переделка визуализации по образцу PDF
- [x] Изменить ориентацию swimlane с горизонтальной на вертикальную (колонки ролей)
- [x] Использовать простые текстовые блоки вместо фигур
- [x] Добавить детальное описание МОП внутри блоков
- [x] Реализовать вертикальное расположение шагов внутри колонок
- [x] Добавить горизонтальные связи между колонками
- [x] Использовать пастельные цвета для колонок ролей
- [x] Добавить нумерацию шагов

## Исправления связей и детализации
- [x] Восстановить отображение связей между блоками
- [x] Углубить детализацию шагов (роль, действия, ИС, время, подэтапы)
- [x] Обновить схему БД для хранения детальной информации
- [x] Обновить промпт LLM для генерации подробных данных
- [x] Добавить отображение информационных систем в блоках
- [x] Добавить подэтапы внутри каждого шага

## Улучшения UI
- [x] Добавить видимые стрелки связей между блоками
- [x] Сделать фильтр по ролям сворачиваемым

## Переделка диаграммы с элементами блок-схем
- [x] Использовать стандартные формы блок-схем (прямоугольник, ромб, овал, параллелограмм)
- [x] Добавить четкие стрелки между всеми элементами процесса
- [x] Реализовать автоматическое позиционирование элементов
- [x] Исправить ошибку undefined в forEach - добавить проверки на существование массивов
- [x] Исправить ошибку с branch.options - добавить проверку на undefined для вложенных массивов

## Исправление отображения деталей в блоках
- [x] Исправить отображение названий шагов (использовать name вместо title)
- [x] Добавить поддержку обоих полей type и shapeType для совместимости
- [x] Увеличить размер блоков для лучшей читаемости (260x120px)
- [x] Добавить отображение описания шага внутри блока (до 120 символов)
- [x] Добавить отображение ответственного лица в блоке
- [x] Добавить отображение времени выполнения в блоке
- [x] Улучшить spacing между элементами внутри блоков

## Расширение функциональности анкетирования
- [x] Создать расширенную систему вопросов (50 вопросов по блокам A-G)
- [x] Реализовать сокращенную версию анкеты (10 самых важных вопросов)
- [x] Добавить выбор варианта анкеты (полная/сокращенная) на странице интервью
- [x] Реализовать сохранение черновиков анкеты
- [x] Добавить возможность возврата к незавершенному интервью
- [x] Реализовать прикрепление документов к компании
- [x] Добавить загрузку документов в S3
- [x] Обновить схему БД для хранения черновиков и документов

## Переделка визуализации процесса по новым правилам
- [x] Обновить промпт генерации процесса согласно правилам из текстового файла
- [ ] Добавить генерацию уровня 0 (крупные этапы процесса)
- [ ] Реализовать детальную таблицу блоков с полями: ID, этап, название, роль, тип узла, вход/выход, действия, система, SLA, связи, документы
- [ ] Добавить генерацию логики ветвлений и условий
- [ ] Добавить привязку к CRM/воронкам и автоматизации
- [ ] Добавить перечень недостающих регламентов и шаблонов
- [x] Переделать визуализацию диаграммы по образцу PDF (горизонтальная swimlane)
- [x] Реализовать отображение крупных этапов сверху диаграммы
- [x] Добавить поддержку типов узлов: Start, Action, Decision, Split, Merge, Event, End
- [x] Реализовать отображение параллельных веток и условий

## Улучшение UX анкетирования (19.11.2025)
- [x] Сделать текст примеров в вопросах копируемым (заменить placeholder на отдельный блок с примером)

## Исправление багов анкетирования (19.11.2025)
- [x] Исправить пропадание текста при заполнении полей анкеты

## Расширение функциональности процессов (19.11.2025)
- [x] Добавить drag & drop для перетаскивания элементов между этапами и участниками
- [x] Реализовать сохранение позиций элементов после перетаскивания (компонент готов)
- [x] Добавить экспорт процесса в PDF с диаграммой и описанием
- [x] Создать раздел с детальным описанием каждого этапа (что делать, где, в какой системе)
- [x] Добавить вопросы о зарплатах ролей в анкету
- [x] Реализовать расчет общего времени процесса (в промпте)
- [x] Реализовать расчет затрат по ФОТ для процесса (в промпте)
- [x] Генерировать 3 варианта воронок CRM для автоматизации (в промпте)
- [x] Создать раздел "Документы" с перечнем необходимых регламентов и шаблонов
- [x] Обновить промпт генерации для создания детальных описаний и рекомендаций
- [x] Создать UI панели для отображения метрик, воронок, документов
- [x] Интегрировать drag & drop в ProcessView

## Исправления drag & drop и UI (19.11.2025)
- [x] Исправить drag & drop - добавлены импорты и улучшена визуализация
- [x] Проверить и исправить отображение всех столбцов процесса - добавлена горизонтальная прокрутка
- [x] Создать диалоговое окно для запросов изменений процесса (текстовый ввод)
- [x] Добавить голосовой ввод в диалог изменений
- [ ] Реализовать обработку запросов на изменение через LLM

## Исправление ошибок API (19.11.2025)
- [x] Исправить ошибку companies.get с id:0 на странице процесса
- [x] Исправить ошибку Cannot read properties of undefined (reading 'length') в CRMFunnels

## Подготовка к GitHub (19.11.2025)
- [x] Создать README.md с описанием проекта
- [x] Создать .gitignore для проекта (уже существует)
- [x] Создать LICENSE файл
- [x] Написать инструкцию по подключению домена reg.ru

## Исправления и новые функции (20.11.2025)
- [ ] Исправить отображение полей ввода в анкете (нужно проверить соответствие ID блоков)
- [x] Добавить систему баланса токенов в БД
- [x] Создать страницу личного кабинета с отображением баланса
- [x] Добавить удаление компаний с всплывающим окном подтверждения
- [x] Реализовать автоматический переход к результатам если интервью уже завершено
- [x] Добавить возможность перейти на другой способ интервью из результатов

## Улучшение UI (20.11.2025)
- [x] Исправить форматирование на странице результатов ProcessView - текст накладывается друг на друга

## Управление процессами (20.11.2025)
- [x] Добавить backend endpoint для удаления процессов
- [x] Создать страницу со списком всех сохраненных процессов компании
- [x] Добавить кнопку удаления процесса с подтверждением
- [x] Показывать список процессов на странице компании перед выбором способа интервью

## Улучшение визуализации (20.11.2025)
- [x] Улучшить визуализацию BPMN-диаграммы - текст все еще обрезается, нужно еще больше увеличить блоки

## Админ-панель (24.11.2025)
- [x] Создать таблицу error_logs в БД для хранения логов ошибок
- [x] Добавить backend endpoints для управления пользователями (список, редактирование баланса)
- [x] Добавить backend endpoint для получения логов ошибок
- [x] Создать страницу админ-панели с таблицей всех пользователей
- [x] Добавить возможность редактирования баланса пользователей
- [x] Добавить просмотр логов ошибок системы
- [x] Назначить роль admin для citymanage.ekb@gmail.com в БД

## Аналитика (24.11.2025)
- [x] Добавить код Яндекс.Метрики (ID: 105485872) во все страницы сайта

## Исправление Яндекс.Метрики (24.11.2025)
- [x] Проверить почему счетчик не работает на опубликованном сайте biz-process.ru
- [x] Убедиться что скрипт загружается на dev сервере
- [x] Опубликовать исправленную версию

## Система списания токенов (24.11.2025)
- [x] Определить стоимость генерации процесса в токенах
- [x] Добавить проверку баланса перед генерацией процесса
- [x] Реализовать автоматическое списание токенов при успешной генерации
- [x] Добавить обработку ошибки недостаточного баланса
- [x] Отображать стоимость генерации на странице интервью
- [x] Обновить баланс в UI после списания токенов
- [x] Протестировать сценарии: достаточно токенов, недостаточно токенов, ошибка генерации

## Система поддержки с чатом (24.11.2025)
- [x] Создать таблицы support_chats и support_messages в БД
- [x] Добавить backend API для создания чата и отправки сообщений
- [x] Добавить backend API для получения списка чатов (для админа)
- [x] Добавить backend API для получения истории сообщений
- [x] Реализовать автоматическое приветственное сообщение при создании чата
- [x] Создать плавающий виджет чата (кнопка + окно чата)
- [x] Добавить виджет чата во все страницы приложения
- [x] Реализовать отправку сообщений от пользователя
- [x] Добавить real-time обновление сообщений через polling
- [x] Создать страницу админ-панели для просмотра всех чатов
- [x] Добавить возможность отвечать на сообщения пользователей
- [x] Отображать информацию о пользователе (имя, email, время)
- [x] Добавить индикатор непрочитанных сообщений для админа

## Email-уведомления и база знаний (FAQ) (24.11.2025) - ЗАВЕРШЕНО
### Email-уведомления
- [x] Настроить отправку email через встроенный notification API
- [x] Добавить отправку уведомления при получении нового сообщения от пользователя
- [x] Включить в уведомление информацию о пользователе и текст сообщения

### База знаний (FAQ)
- [x] Создать таблицу faq_articles в БД для хранения статей
- [x] Добавить backend API для управления FAQ (CRUD)
- [x] Реализовать поиск по ключевым словам в FAQ
- [x] Добавить автоматические подсказки в чат на основе ключевых слов
- [x] Создать страницу /faq для просмотра базы знаний
- [x] Добавить админ-панель для управления FAQ
- [x] Заполнить базу начальными вопросами и ответами

## Исправление ошибки Maximum update depth exceeded (24.11.2025) - ЗАВЕРШЕНО
- [x] Диагностировать причину бесконечного цикла в SupportChat
- [x] Исправить useEffect с зависимостями
- [x] Протестировать работу чата без ошибок

## Real-time уведомления через WebSocket (25.11.2025)

### Backend (Socket.IO)
- [x] Установить socket.io на backend
- [x] Настроить Socket.IO сервер в server/_core/index.ts
- [x] Добавить аутентификацию для WebSocket соединений
- [x] Реализовать события: join_chat, new_message, message_read
- [x] Отправлять события при создании нового сообщения

### Frontend
- [x] Установить socket.io-client на frontend
- [x] Создать хук useSocket для управления WebSocket соединением
- [x] Заменить polling на WebSocket в SupportChat
- [x] Заменить polling на WebSocket в AdminSupport
- [x] Добавить индикатор статуса подключения (онлайн/оффлайн)

### Тестирование
- [x] Протестировать мгновенную доставку сообщений пользователю
- [x] Протестировать мгновенную доставку сообщений администратору
- [x] Проверить переподключение при разрыве соединения
- [x] Проверить работу при открытии чата в нескольких вкладках

## Замена системы авторизации (декабрь 2025)
- [x] Удалить Manus OAuth
- [x] Реализовать авторизацию через Google OAuth 2.0
- [x] Реализовать авторизацию через Email/Password
- [x] Обновить документацию

## Упрощение авторизации (декабрь 2025)
- [x] Удалить Google OAuth
- [x] Оставить только Email/Password
- [x] Обновить документацию

## Email верификация и восстановление пароля (декабрь 2025)
- [x] Обновить схему БД (добавить emailVerified, verificationTokens)
- [x] Реализовать отправку email через nodemailer
- [x] Реализовать подтверждение email при регистрации
- [x] Реализовать восстановление пароля через email
- [x] Обновить UI (страницы верификации, сброса пароля)
- [x] Обновить документацию

## Миграция на PostgreSQL (декабрь 2025)
- [x] Обновить зависимости (drizzle-orm, postgres driver)
- [x] Переписать схему БД под PostgreSQL
- [x] Обновить drizzle.config.ts
- [x] Создать инструкцию по настройке Render PostgreSQL

## Исправление ошибки деплоя (декабрь 2025)
- [x] Удалить старые MySQL миграции
- [x] Создать чистые PostgreSQL миграции
- [x] Обновить архив для GitHub

## Исправление SESSION_SECRET для Render (декабрь 2025)
- [x] Исправить чтение SESSION_SECRET из process.env
- [x] Обновить GitHub

## Исправление 404 в production (декабрь 2025)
- [x] Исправить раздачу статических файлов в production
- [x] Обновить GitHub

## Исправление двойного пути dist/dist/public (декабрь 2025)
- [ ] Исправить логику определения пути в vite.ts
- [ ] Обновить GitHub

## Исправление 404 на SPA роутах (декабрь 2025)
- [ ] Проверить fallback для всех роутов в production
- [ ] Обновить GitHub

## Улучшение UX регистрации (04.12.2025)
- [x] Добавить анимированную кнопку с индикатором загрузки при регистрации
- [x] Показывать toast-уведомление после успешной регистрации
- [x] Автоматически переключать на вкладку "Вход" после регистрации
- [x] Добавить отображение ошибок регистрации в UI

## Исправление email-верификации (04.12.2025)
- [x] Проверить код отправки email в server/routers.ts
- [x] Убедиться что SMTP переменные окружения читаются корректно
- [x] Проверить настройку nodemailer транспорта
- [ ] Протестировать отправку email на реальный адрес
- [x] Добавить логирование для отладки отправки писем

## Интеграция SendGrid для email (04.12.2025)
- [x] Установить пакет @sendgrid/mail
- [x] Переписать email модуль для использования SendGrid API вместо nodemailer
- [ ] Обновить переменные окружения (SENDGRID_API_KEY вместо SMTP_*)
- [ ] Протестировать отправку email через SendGrid
- [ ] Обновить документацию EMAIL_SETUP.md

## Упрощение аутентификации (04.12.2025)
- [x] Добавить поле phone в таблицу users
- [x] Удалить таблицу verification_tokens из схемы
- [x] Убрать email-верификацию из authRoutes
- [x] Убрать восстановление пароля из authRoutes
- [x] Добавить поле телефона в форму регистрации
- [x] Реализовать вход по email+пароль
- [x] Реализовать вход по телефон+пароль
- [x] Удалить неиспользуемые email функции

## Валидация формата телефона (04.12.2025)
- [x] Установить react-phone-number-input
- [x] Создать компонент PhoneInput с валидацией
- [x] Интегрировать в форму регистрации
- [ ] Добавить валидацию на backend
- [ ] Протестировать с разными форматами номеров

## Удаление SendGrid (04.12.2025)
- [x] Удалить пакет @sendgrid/mail
- [x] Удалить файл server/_core/email.ts
- [x] Проверить что нет импортов email модуля

## Исправление деплоя на Render (05.12.2025)
- [x] Найти где используется путь src/public в server/_core/index.ts
- [x] Изменить на dist/public для production
- [x] Протестировать локально
- [x] Отправить на GitHub и проверить деплой

## Исправление distPath для Render (05.12.2025)
- [x] Изменить логику определения distPath в vite.ts
- [x] Использовать правильный путь относительно dist/index.js
- [x] Отправить на GitHub и проверить деплой

## Исправление 404 на /login (05.12.2025)
- [x] Проверить текущий fallback в serveStatic
- [x] Убедиться что fallback работает для всех не-API маршрутов
- [x] Отправить на GitHub и проверить на production

## Исправление ERR_HTTP_HEADERS_SENT (08.12.2025)
- [x] Исправить callback функцию в res.sendFile для предотвращения двойной отправки ответа
- [x] Добавить роут /login в App.tsx (основная причина 404)
- [x] Протестировать локально что /login открывается
- [x] Отправить на GitHub и проверить деплой на Render

## Условная навигация на главной странице (08.12.2025)
- [x] Обновить шапку главной страницы: для авторизованных показывать "Личный кабинет", "Компании" вместо "Вход"
- [x] Обновить главную кнопку: для авторизованных показывать "Создать компанию" вместо "Начать бесплатно"
- [x] Добавить переходы: Личный кабинет → /profile, Компании → /companies, Создать компанию → /companies
- [x] Отправить на GitHub

## Исправление проблемы с сессией после входа (08.12.2025)
- [x] Диагностировать почему после успешного входа главная страница не показывает авторизованное состояние
- [x] Проверить сохранение cookie и session после входа
- [x] Исправить код обработки входа для корректного сохранения сессии (добавлен refetchOnMount: 'always')
- [x] Отправить на GitHub

## Исправление несоответствия базы данных (08.12.2025)
- [x] Диагностировать проблему - найдено несоответствие MySQL/TiDB vs PostgreSQL
- [x] Использовать существующую PostgreSQL базу из Render
- [x] Обновить DATABASE_URL на PostgreSQL с SSL
- [x] Применить миграции (pnpm db:push)
- [x] Протестировать вход и авторизацию - работает корректно!

## Исправление ошибки деплоя - отсутствует jsonwebtoken (09.12.2025)
- [x] Проверить изменения в репозитории
- [x] Найти где используется jsonwebtoken (server/_core/context.ts)
- [x] Добавить jsonwebtoken в package.json
- [x] Отправить на GitHub (commit 7320da2)

## Полная диагностика проблемы с авторизацией (09.12.2025)
- [ ] Проверить что API /api/trpc/auth.me возвращает данные пользователя после входа
- [ ] Проверить что cookie сохраняется после входа
- [ ] Проверить useAuth hook корректно обрабатывает данные
- [ ] Проверить что Home.tsx использует правильную логику отображения
- [ ] Проверить что Login.tsx корректно сохраняет сессию при входе
- [ ] Исправить найденные проблемы
- [ ] Протестировать полный flow: регистрация → вход → главная страница
- [ ] Отправить на GitHub

## Диагностика проблемы авторизации на production (10.12.2025)
- [x] Открыть https://business-process-builder.onrender.com в браузере
- [x] Проверить загрузку главной страницы
- [x] Попытаться войти с тестовым аккаунтом - вход работает, редирект происходит
- [x] Проверить Network tab - /api/trpc/auth.me возвращает {"result": {"data": {"json": null}}}
- [x] Проверить установку cookie после входа - document.cookie = "" (пустая строка!)
- [x] Проверить Console на JavaScript ошибки - нет ошибок
- [x] Найти причину проблемы - cookie не устанавливается из-за secure: true без trust proxy
- [x] Исправить - добавлен app.set('trust proxy', 1) в server/_core/index.ts
- [x] Задеплоить исправление на Render (commit ea203ff)

## Проверка после деплоя trust proxy (10.12.2025)
- [x] Открыть production сайт заново
- [x] Попытаться войти снова - получена ошибка 401 "Missing credentials"
- [x] Проверить установку cookie после входа - document.cookie = "" (пустая)
- [x] Найти причину - Passport usernameField='email' но frontend отправляет 'identifier'
- [x] Исправить - изменен usernameField на 'identifier' в auth.ts
- [x] Задеплоить исправление (commit 40b1b10)

## Диагностика "Missing credentials" после исправления usernameField (10.12.2025)
- [x] Проверить код Login.tsx - какие поля отправляются - нашел что отправляет 'email' вместо 'identifier'
- [x] Найти причину проблемы - несоответствие между frontend (email) и backend (identifier)
- [x] Исправить - изменен Login.tsx чтобы отправлял 'identifier'
- [x] Протестировать локально - РАБОТАЕТ! Навигация обновляется после входа
- [x] Задеплоить на production (commit 796595b)

## Проблема: главный экран не обновляется после входа на production (10.12.2025)
- [x] Открыть production сайт
- [x] Войти с тестовыми данными - редирект работает но навигация не меняется
- [x] Проверить что возвращает /api/trpc/auth.me после входа - возвращает null
- [x] Проверить console на ошибки - document.cookie пустая
- [x] Найти причину - cookie не устанавливается из-за sameSite: 'lax' с secure: true через proxy
- [x] Исправить проблему - изменен sameSite на 'none' для production
- [x] Протестировать локально - РАБОТАЕТ!
- [x] Задеплоить на production (commit 7a662fc)

## Углубленная диагностика - все еще не работает (10.12.2025)
- [x] Проверить что деплой завершился на Render - завершился
- [x] Войти на production и проверить Network tab - Set-Cookie header: null!
- [x] Проверить Set-Cookie заголовки в ответе - не приходит!
- [x] Найти корневую причину - Cloudflare proxy удаляет Set-Cookie заголовки от res.cookie()
- [x] Реализовать финальное решение - заменить res.cookie() на res.setHeader('Set-Cookie')
- [x] Протестировать локально - РАБОТАЕТ!
- [ ] Задеплоить на production
